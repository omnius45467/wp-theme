<?php
$line_icons = "";
$line_icons = '<li><i class="icon-boat"></i><span class="icon-name">icon-boat</span></li><li><i class="icon-booknote"></i><span class="icon-name">icon-booknote</span></li><li><i class="icon-booknote-add"></i><span class="icon-name">icon-booknote-add</span></li><li><i class="icon-booknote-remove"></i><span class="icon-name">icon-booknote-remove</span></li><li><i class="icon-camera-2"></i><span class="icon-name">icon-camera-2</span></li><li><i class="icon-cloud-check"></i><span class="icon-name">icon-cloud-check</span></li><li><i class="icon-cloud-delete"></i><span class="icon-name">icon-cloud-delete</span></li><li><i class="icon-cloud-download"></i><span class="icon-name">icon-cloud-download</span></li><li><i class="icon-cloud-upload"></i><span class="icon-name">icon-cloud-upload</span></li><li><i class="icon-cloudy"></i><span class="icon-name">icon-cloudy</span></li><li><i class="icon-cocktail"></i><span class="icon-name">icon-cocktail</span></li><li><i class="icon-coffee"></i><span class="icon-name">icon-coffee</span></li><li><i class="icon-compass"></i><span class="icon-name">icon-compass</span></li><li><i class="icon-compress"></i><span class="icon-name">icon-compress</span></li><li><i class="icon-cutlery"></i><span class="icon-name">icon-cutlery</span></li><li><i class="icon-delete"></i><span class="icon-name">icon-delete</span></li><li><i class="icon-delete-folder"></i><span class="icon-name">icon-delete-folder</span></li><li><i class="icon-dialogue-add"></i><span class="icon-name">icon-dialogue-add</span></li><li><i class="icon-dialogue-delete"></i><span class="icon-name">icon-dialogue-delete</span></li><li><i class="icon-dialogue-happy"></i><span class="icon-name">icon-dialogue-happy</span></li><li><i class="icon-dialogue-sad"></i><span class="icon-name">icon-dialogue-sad</span></li><li><i class="icon-dialogue-text"></i><span class="icon-name">icon-dialogue-text</span></li><li><i class="icon-dialogue-think"></i><span class="icon-name">icon-dialogue-think</span></li><li><i class="icon-diamond"></i><span class="icon-name">icon-diamond</span></li><li><i class="icon-dish-fork"></i><span class="icon-name">icon-dish-fork</span></li><li><i class="icon-dish-spoon"></i><span class="icon-name">icon-dish-spoon</span></li><li><i class="icon-download"></i><span class="icon-name">icon-download</span></li><li><i class="icon-download-folder"></i><span class="icon-name">icon-download-folder</span></li><li><i class="icon-expand"></i><span class="icon-name">icon-expand</span></li><li><i class="icon-eye"></i><span class="icon-name">icon-eye</span></li><li><i class="icon-fast-food"></i><span class="icon-name">icon-fast-food</span></li><li><i class="icon-flag"></i><span class="icon-name">icon-flag</span></li><li><i class="icon-folder"></i><span class="icon-name">icon-folder</span></li><li><i class="icon-geolocalizator"></i><span class="icon-name">icon-geolocalizator</span></li><li><i class="icon-globe"></i><span class="icon-name">icon-globe</span></li><li><i class="icon-graph"></i><span class="icon-name">icon-graph</span></li><li><i class="icon-graph-descending"></i><span class="icon-name">icon-graph-descending</span></li><li><i class="icon-graph-rising"></i><span class="icon-name">icon-graph-rising</span></li><li><i class="icon-hammer"></i><span class="icon-name">icon-hammer</span></li><li><i class="icon-happy-drop"></i><span class="icon-name">icon-happy-drop</span></li><li><i class="icon-headphones"></i><span class="icon-name">icon-headphones</span></li><li><i class="icon-heart"></i><span class="icon-name">icon-heart</span></li><li><i class="icon-heart-broken"></i><span class="icon-name">icon-heart-broken</span></li><li><i class="icon-home"></i><span class="icon-name">icon-home</span></li><li><i class="icon-hourglass"></i><span class="icon-name">icon-hourglass</span></li><li><i class="icon-image"></i><span class="icon-name">icon-image</span></li><li><i class="icon-key"></i><span class="icon-name">icon-key</span></li><li><i class="icon-life-buoy"></i><span class="icon-name">icon-life-buoy</span></li><li><i class="icon-list"></i><span class="icon-name">icon-list</span></li><li><i class="icon-lock-closed"></i><span class="icon-name">icon-lock-closed</span></li><li><i class="icon-lock-open"></i><span class="icon-name">icon-lock-open</span></li><li><i class="icon-loudspeaker"></i><span class="icon-name">icon-loudspeaker</span></li><li><i class="icon-magnifier"></i><span class="icon-name">icon-magnifier</span></li><li><i class="icon-magnifier-minus"></i><span class="icon-name">icon-magnifier-minus</span></li><li><i class="icon-magnifier-plus"></i><span class="icon-name">icon-magnifier-plus</span></li><li><i class="icon-mail"></i><span class="icon-name">icon-mail</span></li><li><i class="icon-mail-open"></i><span class="icon-name">icon-mail-open</span></li><li><i class="icon-map"></i><span class="icon-name">icon-map</span></li><li><i class="icon-medical-case"></i><span class="icon-name">icon-medical-case</span></li><li><i class="icon-microphone-1"></i><span class="icon-name">icon-microphone-1</span></li><li><i class="icon-microphone-2"></i><span class="icon-name">icon-microphone-2</span></li><li><i class="icon-minus"></i><span class="icon-name">icon-minus</span></li><li><i class="icon-multiple-image"></i><span class="icon-name">icon-multiple-image</span></li><li><i class="icon-music-back"></i><span class="icon-name">icon-music-back</span></li><li><i class="icon-music-backtoend"></i><span class="icon-name">icon-music-backtoend</span></li><li><i class="icon-music-eject"></i><span class="icon-name">icon-music-eject</span></li><li><i class="icon-music-forward"></i><span class="icon-name">icon-music-forward</span></li><li><i class="icon-music-forwardtoend"></i><span class="icon-name">icon-music-forwardtoend</span></li><li><i class="icon-music-pause"></i><span class="icon-name">icon-music-pause</span></li><li><i class="icon-music-play"></i><span class="icon-name">icon-music-play</span></li><li><i class="icon-music-random"></i><span class="icon-name">icon-music-random</span></li><li><i class="icon-music-repeat"></i><span class="icon-name">icon-music-repeat</span></li><li><i class="icon-music-stop"></i><span class="icon-name">icon-music-stop</span></li><li><i class="icon-musical-note"></i><span class="icon-name">icon-musical-note</span></li><li><i class="icon-musical-note-2"></i><span class="icon-name">icon-musical-note-2</span></li><li><i class="icon-old-video-cam"></i><span class="icon-name">icon-old-video-cam</span></li><li><i class="icon-paper-pen"></i><span class="icon-name">icon-paper-pen</span></li><li><i class="icon-paper-pencil"></i><span class="icon-name">icon-paper-pencil</span></li><li><i class="icon-paper-sheet"></i><span class="icon-name">icon-paper-sheet</span></li><li><i class="icon-pen-pencil-ruler"></i><span class="icon-name">icon-pen-pencil-ruler</span></li><li><i class="icon-pencil"></i><span class="icon-name">icon-pencil</span></li><li><i class="icon-pencil-ruler"></i><span class="icon-name">icon-pencil-ruler</span></li><li><i class="icon-plus"></i><span class="icon-name">icon-plus</span></li><li><i class="icon-portable-pc"></i><span class="icon-name">icon-portable-pc</span></li><li><i class="icon-pricetag"></i><span class="icon-name">icon-pricetag</span></li><li><i class="icon-printer"></i><span class="icon-name">icon-printer</span></li><li><i class="icon-profile"></i><span class="icon-name">icon-profile</span></li><li><i class="icon-profile-add"></i><span class="icon-name">icon-profile-add</span></li><li><i class="icon-profile-remove"></i><span class="icon-name">icon-profile-remove</span></li><li><i class="icon-rainy"></i><span class="icon-name">icon-rainy</span></li><li><i class="icon-rotate"></i><span class="icon-name">icon-rotate</span></li><li><i class="icon-setting-1"></i><span class="icon-name">icon-setting-1</span></li><li><i class="icon-setting-2"></i><span class="icon-name">icon-setting-2</span></li><li><i class="icon-share"></i><span class="icon-name">icon-share</span></li><li><i class="icon-shield-down"></i><span class="icon-name">icon-shield-down</span></li><li><i class="icon-shield-left"></i><span class="icon-name">icon-shield-left</span></li><li><i class="icon-shield-right"></i><span class="icon-name">icon-shield-right</span></li><li><i class="icon-shield-up"></i><span class="icon-name">icon-shield-up</span></li><li><i class="icon-shopping-cart"></i><span class="icon-name">icon-shopping-cart</span></li><li><i class="icon-shopping-cart-content"></i><span class="icon-name">icon-shopping-cart-content</span></li><li><i class="icon-sinth"></i><span class="icon-name">icon-sinth</span></li><li><i class="icon-smartphone"></i><span class="icon-name">icon-smartphone</span></li><li><i class="icon-spread"></i><span class="icon-name">icon-spread</span></li><li><i class="icon-squares"></i><span class="icon-name">icon-squares</span></li><li><i class="icon-stormy"></i><span class="icon-name">icon-stormy</span></li><li><i class="icon-sunny"></i><span class="icon-name">icon-sunny</span></li><li><i class="icon-tablet"></i><span class="icon-name">icon-tablet</span></li><li><i class="icon-three-stripes-horiz"></i><span class="icon-name">icon-three-stripes-horiz</span></li><li><i class="icon-three-stripes-vert"></i><span class="icon-name">icon-three-stripes-vert</span></li><li><i class="icon-ticket"></i><span class="icon-name">icon-ticket</span></li><li><i class="icon-todolist"></i><span class="icon-name">icon-todolist</span></li><li><i class="icon-todolist-add"></i><span class="icon-name">icon-todolist-add</span></li><li><i class="icon-todolist-check"></i><span class="icon-name">icon-todolist-check</span></li><li><i class="icon-trash-bin"></i><span class="icon-name">icon-trash-bin</span></li><li><i class="icon-tshirt"></i><span class="icon-name">icon-tshirt</span></li><li><i class="icon-tv-monitor"></i><span class="icon-name">icon-tv-monitor</span></li><li><i class="icon-umbrella"></i><span class="icon-name">icon-umbrella</span></li><li><i class="icon-upload"></i><span class="icon-name">icon-upload</span></li><li><i class="icon-upload-folder"></i><span class="icon-name">icon-upload-folder</span></li><li><i class="icon-variable"></i><span class="icon-name">icon-variable</span></li><li><i class="icon-video-cam"></i><span class="icon-name">icon-video-cam</span></li><li><i class="icon-volume-higher"></i><span class="icon-name">icon-volume-higher</span></li><li><i class="icon-volume-lower"></i><span class="icon-name">icon-volume-lower</span></li><li><i class="icon-volume-off"></i><span class="icon-name">icon-volume-off</span></li><li><i class="icon-watch"></i><span class="icon-name">icon-watch</span></li><li><i class="icon-waterfall"></i><span class="icon-name">icon-waterfall</span></li><li><i class="icon-website-1"></i><span class="icon-name">icon-website-1</span></li><li><i class="icon-website-2"></i><span class="icon-name">icon-website-2</span></li><li><i class="icon-wine"></i><span class="icon-name">icon-wine</span></li><li><i class="icon-calendar"></i><span class="icon-name">icon-calendar</span></li><li><i class="icon-alarm-clock"></i><span class="icon-name">icon-alarm-clock</span></li><li><i class="icon-add-folder"></i><span class="icon-name">icon-add-folder</span></li><li><i class="icon-accelerator"></i><span class="icon-name">icon-accelerator</span></li><li><i class="icon-agenda"></i><span class="icon-name">icon-agenda</span></li><li><i class="icon-arrow-left"></i><span class="icon-name">icon-arrow-left</span></li><li><i class="icon-arrow-down"></i><span class="icon-name">icon-arrow-down</span></li><li><i class="icon-battery-1"></i><span class="icon-name">icon-battery-1</span></li><li><i class="icon-case"></i><span class="icon-name">icon-case</span></li><li><i class="icon-arrow-up"></i><span class="icon-name">icon-arrow-up</span></li><li><i class="icon-arrow-right"></i><span class="icon-name">icon-arrow-right</span></li><li><i class="icon-case-2"></i><span class="icon-name">icon-case-2</span></li><li><i class="icon-cd"></i><span class="icon-name">icon-cd</span></li><li><i class="icon-battery-2"></i><span class="icon-name">icon-battery-2</span></li><li><i class="icon-battery-3"></i><span class="icon-name">icon-battery-3</span></li><li><i class="icon-check"></i><span class="icon-name">icon-check</span></li><li><i class="icon-battery-4"></i><span class="icon-name">icon-battery-4</span></li><li><i class="icon-chronometer"></i><span class="icon-name">icon-chronometer</span></li><li><i class="icon-clock"></i><span class="icon-name">icon-clock</span></li><li><i class="icon-blackboard-graph"></i><span class="icon-name">icon-blackboard-graph</span></li>'; ?>
<?php
global $line_icons;
add_action( 'admin_init', 'add_event_fields_clone' );
add_action( 'save_post', 'imic_update_event_fields_data', 10, 2 );
/**
 * Add custom Meta Box to Posts post type
 */
function add_event_fields_clone() 
{
    add_meta_box('event_schedule',__('Event Schedule','framework'),'imic_event_feilds_output','event','normal','core');
}
/**
 * Print the Meta Box content
 */
function imic_event_feilds_output() 
{
    global $post, $line_icons;
	// Add an nonce field so we can check for it later.
	wp_nonce_field( 'event_schedule_meta_box', 'event_schedule_meta_box_nonce' );
    $feat_data = get_post_meta( $post->ID, 'feat_data', true );
	
?>
<div id="field_group">
    <div id="field_wrap">
    <?php 
    if ( isset( $feat_data['sch_title'] ) ) 
    {
        for( $i = 0; $i < count( $feat_data['sch_title'] ); $i++ ) 
        {
        ?>
        <div class="field_row">
          <div class="field_left">
          <div class="form_field"><div class="rwmb-label">
              <label><?php _e('Start Time','framework'); ?></label></div><div class="rwmb-input">
              <select type="text"
                     class="meta_feat_title"
                     name="featured[start_time][]"
              >
              <?php
			  $start = "00:00";
$end = "23:45";
$tStart = strtotime($start);
$tEnd = strtotime($end);
$tNow = $tStart;
while($tNow <= $tEnd){
	$sc = ($feat_data['start_time'][$i]==date("H:i",$tNow))?'selected':'';
  echo '<option value="'.date("H:i",$tNow).'" '.$sc.'>'.date("H:i",$tNow).'</option>';
  $tNow = strtotime('+15 minutes',$tNow);
}
?>
              </select></div>
            </div>
            <div class="form_field"><div class="rwmb-label">
              <label><?php _e('End Time','framework'); ?></label></div><div class="rwmb-input">
              <select type="text"
                     class="meta_feat_title"
                     name="featured[end_time][]"
              >
              <?php
			  $start = "00:00";
$end = "23:45";
$tStart = strtotime($start);
$tEnd = strtotime($end);
$tNow = $tStart;
while($tNow <= $tEnd){
	$sc = ($feat_data['end_time'][$i]==date("H:i",$tNow))?'selected':'';
  echo '<option value="'.date("H:i",$tNow).'" '.$sc.'>'.date("H:i",$tNow).'</option>';
  $tNow = strtotime('+15 minutes',$tNow);
}
?>
              </select></div>
            </div>
            <div class="form_field"><div class="rwmb-label">
              <label><?php _e('Title','framework'); ?></label></div><div class="rwmb-input">
              <input type="text"
                     class="meta_sch_title"
                     name="featured[sch_title][]"
                     value="<?php echo esc_html( $feat_data['sch_title'][$i] ); ?>"
              /></div>
            </div>
            <div class="form_field"><div class="rwmb-label">
              <label><?php _e('Icon Type','framework'); ?></label></div><div class="rwmb-input">
              <?php $sc = ($feat_data['icon_type'][$i]==date("H:i",$tNow))?'selected':''; ?>
              <select type="text" class="meta_feat_title" name="featured[icon_type][]">
                                    <option <?php echo ($feat_data['icon_type'][$i]=='label-default')?'selected':''; ?> value="label-default"><?php _e('Default', 'imic-framework-admin'); ?></option>
                                    <option <?php echo ($feat_data['icon_type'][$i]=='label-primary')?'selected':''; ?> value="label-primary"><?php _e('Primary', 'imic-framework-admin'); ?></option>
                                    <option <?php echo ($feat_data['icon_type'][$i]=='label-success')?'selected':''; ?> value="label-success"><?php _e('Success', 'imic-framework-admin'); ?></option>
                                    <option <?php echo ($feat_data['icon_type'][$i]=='label-info')?'selected':''; ?> value="label-info"><?php _e('Info', 'imic-framework-admin'); ?></option>
                                    <option <?php echo ($feat_data['icon_type'][$i]=='label-warning')?'selected':''; ?> value="label-warning"><?php _e('Warning', 'imic-framework-admin'); ?></option>
                                    <option <?php echo ($feat_data['icon_type'][$i]=='label-danger')?'selected':''; ?> value="label-danger"><?php _e('Danger', 'imic-framework-admin'); ?></option>
                                </select></div>
            </div>
            <div class="form_field icon_field"><div class="rwmb-label">
              <label><?php _e('Select Icon','framework'); ?></label></div><div class="rwmb-input">
              <input type="text"
              			id="icon-image" 
                     class="meta_line_icon"
                     name="featured[line_icon][]"
                     value="<?php echo esc_html( $feat_data['line_icon'][$i] ); ?>"
              /></div>
              <ul class="font-icon-grid"><?php echo $line_icons; ?></ul>
            </div>
          </div>
          <div class="field_right">
            <input class="button" type="button" value="<?php _E('Remove','framework'); ?>" onclick="remove_field(this)" />
          </div>
          <div class="clear" /></div> 
        </div>
        <?php
        } // endif
    } // endforeach
    ?>
    </div>
    <div style="display:none" id="master-row">
    <div class="field_row">
        <div class="field_left">
        <div class="form_field">
        <div class="rwmb-label">
              <label><?php _e('Start Time','framework'); ?></label></div><div class="rwmb-input">
              <select type="text"
                     class="meta_feat_title"
                     name="featured[start_time][]"
              >
              <?php
			  $start = "00:00";
$end = "23:45";
$tStart = strtotime($start);
$tEnd = strtotime($end);
$tNow = $tStart;
while($tNow <= $tEnd){
  echo '<option value="'.date("H:i",$tNow).'">'.date("H:i",$tNow).'</option>';
  $tNow = strtotime('+15 minutes',$tNow);
}
?>
              </select></div>
            </div>
            <div class="form_field">
            <div class="rwmb-label">
              <label><?php _e('End Time','framework'); ?></label></div><div class="rwmb-input">
              <select type="text"
                     class="meta_feat_title"
                     name="featured[end_time][]"
              >
              <?php
			  $start = "00:00";
$end = "23:45";
$tStart = strtotime($start);
$tEnd = strtotime($end);
$tNow = $tStart;
while($tNow <= $tEnd){
  echo '<option value="'.date("H:i",$tNow).'">'.date("H:i",$tNow).'</option>';
  $tNow = strtotime('+15 minutes',$tNow);
}
?>
              </select></div>
            </div>
            <div class="form_field"><div class="rwmb-label">
                <label><?php _e('Title','framework'); ?></label></div><div class="rwmb-input">
                <input class="meta_sch_title" value="" type="text" name="featured[sch_title][]" /></div>
            </div>
            <div class="form_field"><div class="rwmb-label">
              <label><?php _e('Icon Type','framework'); ?></label></div><div class="rwmb-input">
              <select type="text" class="meta_feat_title" name="featured[icon_type][]">
                                    <option value="label-default"><?php _e('Default', 'imic-framework-admin'); ?></option>
                                    <option value="label-primary"><?php _e('Primary', 'imic-framework-admin'); ?></option>
                                    <option value="label-success"><?php _e('Success', 'imic-framework-admin'); ?></option>
                                    <option value="label-info"><?php _e('Info', 'imic-framework-admin'); ?></option>
                                    <option value="label-warning"><?php _e('Warning', 'imic-framework-admin'); ?></option>
                                    <option value="label-danger"><?php _e('Danger', 'imic-framework-admin'); ?></option>
                                </select></div>
            </div>
            <div class="form_field icon_field"><div class="rwmb-label">
                <label><?php _e('Select Icon','framework'); ?></label></div><div class="rwmb-input">
                <input class="meta_line_icon" value="" id="icon-image" type="text" name="featured[line_icon][]" /></div>
                <ul class="font-icon-grid"><?php echo $line_icons; ?></ul>
            </div>
        </div>
        <div class="field_right image_wrap">
        </div> 
        <div class="field_right"> 
            <input class="button" type="button" value="<?php _e('Remove','framework'); ?>" onclick="remove_field(this)" /> 
        </div>
        <div class="clear"></div>
    </div>
    </div>
    <div id="add_field_row">
      <input class="button" type="button" value="<?php _e('Add Featured Field','framework'); ?>" onclick="add_field_row();" />
    </div>
</div>
  <?php
}
/**
 * Save post action, process fields
 */
function imic_update_event_fields_data( $post_id, $post_object ) 
{
    if ( ! isset( $_POST['event_schedule_meta_box_nonce'] ) ) {
		return;
	}
	// Verify that the nonce is valid.
	if ( ! wp_verify_nonce( $_POST['event_schedule_meta_box_nonce'], 'event_schedule_meta_box' ) ) {
		return;
	}
    // Doing revision, exit earlier **can be removed**
    if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE )  
        return;
    // Doing revision, exit earlier
    if ( 'revision' == $post_object->post_type )
        return;
    // Verify authenticity
	// Check the user's permissions.
	if ( isset( $_POST['post_type'] ) && 'event' == $_POST['post_type'] ) {
		if ( ! current_user_can( 'edit_page', $post_id ) ) {
			return;
		}
	} else {
		if ( ! current_user_can( 'edit_post', $post_id ) ) {
			return;
		}
	}
	/* OK, it's safe for us to save the data now. */
	
	// Make sure that it is set.
	if ( ! isset( $_POST['featured'] ) ) {
		return;
	}
    if ( $_POST['featured'] ) 
    {
        // Build array for saving post meta
        $feat_data = array();
        for ($i = 0; $i < count( $_POST['featured']['sch_title'] ); $i++ ) 
        {
            if ( '' != $_POST['featured']['sch_title'][ $i ] ) 
            {
				$feat_data['start_time'][]  = $_POST['featured']['start_time'][ $i ];
				$feat_data['end_time'][]  = $_POST['featured']['end_time'][ $i ];
                $feat_data['sch_title'][]  = $_POST['featured']['sch_title'][ $i ];
				$feat_data['icon_type'][]  = $_POST['featured']['icon_type'][ $i ];
				$feat_data['line_icon'][]  = $_POST['featured']['line_icon'][ $i ];
            }
        }
        if ( $feat_data ) 
            update_post_meta( $post_id, 'feat_data', $feat_data );
        else 
            delete_post_meta( $post_id, 'feat_data' );
    } 
    // Nothing received, all fields are empty, delete option
    else 
    {
        delete_post_meta( $post_id, 'feat_data' );
    }
}
function add_admin_scripts_event( $hook ) {
    global $post;
    if ( $hook == 'post-new.php' || $hook == 'post.php' ) {
        if ( 'event' === $post->post_type ) {     
            wp_enqueue_script(  'myscript', IMIC_THEME_PATH.'/js/clone_fields.js' );
			wp_enqueue_script(  'line_icons', IMIC_THEME_PATH.'/js/line_icons.js' );
			wp_enqueue_style(  'myscript', IMIC_THEME_PATH.'/css/clone_fields.css' );
			wp_enqueue_style(  'line-icons', IMIC_THEME_PATH.'/css/line-icons.css' );
			wp_enqueue_style(  'line_icons_list', IMIC_THEME_PATH.'/css/line_icons_list.css' );
        }
    }
}
add_action( 'admin_enqueue_scripts', 'add_admin_scripts_event', 10, 1 );